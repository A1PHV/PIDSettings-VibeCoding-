# Технические детали алгоритмов

## Обзор методов расчета PID

Программа реализует три метода автоматической настройки PID контроллеров:

### 1. Метод Ziegler-Nichols (Ziegler-Nichols Method)

**Принцип работы:**
Основан на методе предельного цикла. Анализирует характеристики колебаний системы для определения оптимальных параметров.

**Алгоритм:**

1. **Обнаружение колебаний:**
   - Ищем точки пересечения нуля в сигнале ошибки
   - Определяем период колебаний Tu (Ultimate Period)
   - Вычисляем амплитуду колебаний

2. **Расчет предельного усиления (Ku):**
   ```
   Ku = 1 / max_error
   ```
   где max_error - максимальное отклонение от заданного значения

3. **Расчет PID коэффициентов:**
   ```
   P = 0.6 × Ku
   I = 2 × P / Tu
   D = P × Tu / 8
   ```

**Преимущества:**
- Прост в реализации
- Работает для большинства систем
- Не требует знания модели системы

**Недостатки:**
- Может быть слишком агрессивным
- Не учитывает специфику конкретной системы

**Когда использовать:**
- Первая настройка нового БПЛА
- Неизвестные характеристики системы
- Быстрая оценочная настройка

---

### 2. Relay Method (Метод Åström-Hägglund)

**Принцип работы:**
Использует анализ предельных циклов, вызванных релейной обратной связью. Более точен, чем классический Ziegler-Nichols.

**Алгоритм:**

1. **Обнаружение предельного цикла:**
   - Находим пики в сигнале ошибки
   - Измеряем период между пиками
   - Определяем амплитуду процесса (Ap) и управления (Au)

2. **Расчет предельного усиления:**
   ```
   Ku = (4 × Au) / (π × Ap)
   ```

3. **Расчет PID коэффициентов (консервативная настройка):**
   ```
   P = 0.45 × Ku
   I = 1.2 × P / Tu
   D = P × Tu / 10
   ```

**Преимущества:**
- Более консервативная настройка
- Лучше подходит для нестабильных систем
- Меньше перерегулирование

**Недостатки:**
- Может быть медленнее в отклике
- Требует наличия четких колебаний в логе

**Когда использовать:**
- БПЛА склонен к колебаниям
- Нужна более стабильная настройка
- Точная настройка после первичной

---

### 3. System Identification (Идентификация системы)

**Принцип работы:**
Использует метод наименьших квадратов для оценки параметров передаточной функции системы, затем оптимизирует PID на основе целевых метрик.

**Алгоритм:**

1. **Построение регрессионной модели:**
   ```
   u(t) = P × e(t) + I × ∫e(t)dt + D × de(t)/dt
   ```
   где:
   - u(t) - управляющий сигнал
   - e(t) - ошибка
   - P, I, D - коэффициенты (неизвестные)

2. **Формирование матриц:**
   ```
   A = [e(t), Σe(t), Δe(t)]  для всех t
   b = [u(t)]                 для всех t
   ```

3. **Решение методом наименьших квадратов:**
   ```
   x = (A^T × A)^(-1) × A^T × b
   где x = [P, I, D]^T
   ```

4. **Расчет метрик качества:**
   - Перерегулирование (overshoot)
   - Время установления (settling time)
   - Количество колебаний (oscillation count)

5. **Адаптивная коррекция:**
   ```
   P_final = P × (1 - 0.1 × min(overshoot, 1.0))
   I_final = I × (2.0 / (1 + settling_time))
   D_final = D × (1 + 0.1 × oscillation_count)
   ```

**Преимущества:**
- Учитывает фактическое поведение системы
- Адаптируется к характеру полета
- Оптимизирует под конкретные метрики

**Недостатки:**
- Более сложный алгоритм
- Требует достаточного количества данных
- Чувствителен к шуму в данных

**Когда использовать:**
- Финальная тонкая настройка
- Нестандартные конфигурации БПЛА
- Когда другие методы не дают хороших результатов

---

## Метрики качества управления

### Перерегулирование (Overshoot)
```
overshoot = (max_value - target) / target
```
Идеально: < 5%
Приемлемо: < 10%
Плохо: > 20%

### Время установления (Settling Time)
Время, за которое система входит в диапазон ±5% от целевого значения.

Идеально: < 1 секунда
Приемлемо: < 2 секунды
Плохо: > 3 секунды

### Количество колебаний
Число переходов через целевое значение.

Идеально: 1-2
Приемлемо: 3-4
Плохо: > 5

---

## Структуры данных

### FlightDataPoint
```rust
struct FlightDataPoint {
    timestamp: f64,           // Время в секундах

    // Attitude (углы)
    roll_desired: f64,        // Желаемый крен
    roll_actual: f64,         // Фактический крен
    pitch_desired: f64,       // Желаемый тангаж
    pitch_actual: f64,        // Фактический тангаж
    yaw_desired: f64,         // Желаемая рысканье
    yaw_actual: f64,          // Фактическая рысканье

    // Altitude (высота)
    alt_desired: f64,         // Желаемая высота
    alt_actual: f64,          // Фактическая высота

    // Rate (угловые скорости)
    roll_rate: f64,           // Скорость крена (гироскоп X)
    pitch_rate: f64,          // Скорость тангажа (гироскоп Y)
    yaw_rate: f64,            // Скорость рыскания (гироскоп Z)

    // Control outputs (управление)
    throttle: f64,            // Газ
    roll_output: f64,         // Выход Roll
    pitch_output: f64,        // Выход Pitch
    yaw_output: f64,          // Выход Yaw
}
```

### PIDCoefficients
```rust
struct PIDCoefficients {
    p: f64,  // Пропорциональный коэффициент
    i: f64,  // Интегральный коэффициент
    d: f64,  // Дифференциальный коэффициент
}
```

---

## Формат логов Ardupilot

### Формат ATT (Attitude)
```
ATT, TimeUS, DesRoll, Roll, DesPitch, Pitch, DesYaw, Yaw
```
- TimeUS: время в микросекундах
- DesRoll/Roll: желаемый/фактический крен (градусы)
- DesPitch/Pitch: желаемый/фактический тангаж (градусы)
- DesYaw/Yaw: желаемое/фактическое рыскание (градусы)

### Формат RATE (Angular Rates)
```
RATE, TimeUS, RDes, R, PDes, P, YDes, Y
```
- R: фактическая скорость крена (град/с)
- P: фактическая скорость тангажа (град/с)
- Y: фактическая скорость рыскания (град/с)

### Формат CTUN (Control Tuning)
```
CTUN, TimeUS, ThI, ThO, DAlt, Alt, ...
```
- ThI/ThO: газ вход/выход
- DAlt: желаемая высота (м)
- Alt: фактическая высота (м)

### Формат RCOU (RC Output)
```
RCOU, TimeUS, C1, C2, C3, C4, ...
```
- C1: канал 1 (Roll)
- C2: канал 2 (Pitch)
- C3: канал 3 (Throttle)
- C4: канал 4 (Yaw)

---

## Соответствие параметров Ardupilot

### Rate Controllers (контроллеры скорости)

**Roll (Крен):**
- `ATC_RAT_RLL_P` - Пропорциональный
- `ATC_RAT_RLL_I` - Интегральный
- `ATC_RAT_RLL_D` - Дифференциальный
- `ATC_RAT_RLL_FLTD` - Фильтр D (обычно 20Hz)
- `ATC_RAT_RLL_FLTT` - Фильтр входа (обычно 20Hz)

**Pitch (Тангаж):**
- `ATC_RAT_PIT_P`
- `ATC_RAT_PIT_I`
- `ATC_RAT_PIT_D`
- `ATC_RAT_PIT_FLTD`
- `ATC_RAT_PIT_FLTT`

**Yaw (Рыскание):**
- `ATC_RAT_YAW_P`
- `ATC_RAT_YAW_I`
- `ATC_RAT_YAW_D` (обычно 0)
- `ATC_RAT_YAW_FLTE`

### Position Controllers (контроллеры положения)

**Altitude (Высота):**
- `PSC_POSZ_P` - Позиция Z P
- `PSC_VELZ_P` - Скорость Z P (аналог I)
- `PSC_ACCZ_P` - Ускорение Z P
- `PSC_ACCZ_I` - Ускорение Z I
- `PSC_ACCZ_D` - Ускорение Z D

---

## Рекомендации по интерпретации результатов

### Типичные значения для квадрокоптера

**Roll/Pitch:**
- P: 0.03 - 0.15
- I: 0.05 - 0.20
- D: 0.003 - 0.015

**Yaw:**
- P: 0.15 - 0.50
- I: 0.01 - 0.05
- D: 0.0 (обычно не используется)

**Altitude:**
- P: 0.5 - 2.0
- I: 0.2 - 1.0
- D: 0.0 - 0.5

### Признаки проблем

**Слишком высокий P:**
- Высокочастотные колебания
- Нервное поведение
- Перегрев моторов

**Слишком низкий P:**
- Медленная реакция
- "Рыхлое" управление
- Дрейф при маневрах

**Слишком высокий I:**
- Медленные колебания
- Долгое время установления
- "Раскачка" после маневра

**Слишком низкий I:**
- Постоянное отклонение от цели
- Дрейф со временем
- Неспособность удерживать позицию

**Слишком высокий D:**
- Шум в управлении
- Чувствительность к вибрациям
- Нестабильность

**Слишком низкий D:**
- Перерегулирование
- Долгое время установления
- Колебания вокруг цели

---

## Дополнительные ресурсы

### Литература
1. Ziegler, J.G., and Nichols, N.B. (1942). "Optimum settings for automatic controllers"
2. Åström, K.J., and Hägglund, T. (1984). "Automatic tuning of simple regulators"
3. Ardupilot Developer Documentation: https://ardupilot.org/dev/

### Инструменты
- Mission Planner - конфигурация и анализ
- MAVExplorer - анализ логов
- APM Planner 2 - альтернативная наземная станция

### Онлайн калькуляторы
- PID Tuning Calculator: https://pidtuner.com
- Control System Designer (MATLAB)

---

## Лицензия

MIT License
